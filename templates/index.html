<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ChatGPT PDF Completer</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <header>
    <div class="container">
      <h1>ChatGPT PDF Completer</h1>
      <p class="tagline">Upload a PDF, share your notes, and get rapid answers to the four assessment prompts.</p>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <form id="analysis-form" action="/analyze" method="post" enctype="multipart/form-data" class="upload-form">
        <label for="pdf_file">PDF form</label>
        <input type="file" name="pdf_file" id="pdf_file" accept="application/pdf" required>

        <label for="prompt">Notes for ChatGPT</label>
        <textarea name="prompt" id="prompt" rows="6" placeholder="Share any observations or context you want reflected in the answers." required></textarea>

        <div class="hint">
          <p><strong>How it works:</strong> Your notes, the PDF text, and the four assessment questions below are sent to ChatGPT. The answers are returned on this page in a popup so you can quickly review them.</p>
        </div>

        <div class="questions">
          <p class="questions-title">Assessment questions sent to ChatGPT</p>
          <ol>
            {% for question in questions %}
              <li>{{ question }}</li>
            {% endfor %}
          </ol>
        </div>

        <button type="submit">Generate answers</button>
      </form>
    </section>
  </main>

  <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modal-title">
    <div class="modal-content">
      <h2 id="modal-title">ChatGPT answers</h2>
      <div id="modal-body"></div>
      <p id="modal-warning" class="warning" hidden></p>
      <div class="modal-actions">
        <button id="download-pdf" type="button" class="secondary" hidden disabled>Download filled PDF</button>
        <button id="close-modal" type="button">Close</button>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('analysis-form');
    const modal = document.getElementById('modal');
    const modalBody = document.getElementById('modal-body');
    const modalWarning = document.getElementById('modal-warning');
    const closeModal = document.getElementById('close-modal');
    const downloadButton = document.getElementById('download-pdf');
    let currentDownloadUrl = null;

    const base64ToBlob = (base64, contentType) => {
      const binary = atob(base64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i += 1) {
        bytes[i] = binary.charCodeAt(i);
      }
      return new Blob([bytes], { type: contentType });
    };

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(form);

      modalBody.textContent = 'Working on your requestâ€¦';
      modalWarning.hidden = true;
      downloadButton.hidden = true;
      downloadButton.disabled = true;
      modal.classList.add('open');
      if (currentDownloadUrl) {
        URL.revokeObjectURL(currentDownloadUrl);
        currentDownloadUrl = null;
      }

      try {
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData,
        });

        const payload = await response.json();

        if (!response.ok) {
          modalBody.innerHTML = `<p class="error">${payload.error || 'Something went wrong.'}</p>`;
          return;
        }

        const answers = payload.answers || {};
        modalBody.innerHTML = `
          <ol>
            <li>${answers.question1 || 'No answer provided.'}</li>
            <li>${answers.question2 || 'No answer provided.'}</li>
            <li>${answers.question3 || 'No answer provided.'}</li>
            <li>${answers.question4 || 'No answer provided.'}</li>
          </ol>
        `;

        if (payload.warning) {
          modalWarning.textContent = payload.warning;
          modalWarning.hidden = false;
        }

        if (payload.filled_pdf) {
          const blob = base64ToBlob(payload.filled_pdf, 'application/pdf');
          currentDownloadUrl = URL.createObjectURL(blob);
          downloadButton.hidden = false;
          downloadButton.disabled = false;
        }
      } catch (error) {
        modalBody.innerHTML = `<p class="error">Unable to process the request. ${error}</p>`;
      }
    });

    closeModal.addEventListener('click', () => {
      modal.classList.remove('open');
    });

    modal.addEventListener('click', (event) => {
      if (event.target === modal) {
        modal.classList.remove('open');
      }
    });

    downloadButton.addEventListener('click', () => {
      if (!currentDownloadUrl) return;
      const link = document.createElement('a');
      link.href = currentDownloadUrl;
      link.download = 'filled-form.pdf';
      document.body.appendChild(link);
      link.click();
      link.remove();
    });
  </script>
</body>
</html>
